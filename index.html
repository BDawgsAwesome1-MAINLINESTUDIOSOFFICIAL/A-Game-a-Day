<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>A Game a Day ‚Äî Ultra AI Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --accent1:#0b74d1;
  --accent2:#a11ad8;
  --accent3:#ff5a7a;
  --bg-dark:#0a0e27;
  --bg-card:rgba(255,255,255,0.08);
  --text-primary:#ffffff;
  --text-secondary:rgba(255,255,255,0.85);
  --shadow-sm:0 2px 8px rgba(0,0,0,0.1);
  --shadow-md:0 4px 16px rgba(0,0,0,0.2);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.3);
  --shadow-xl:0 16px 48px rgba(0,0,0,0.4);
}
body{
  margin:0;
  font-family:"SF Pro Display","Inter",-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
  background:linear-gradient(135deg,#0b74d1,#a11ad8,#ff5a7a);
  background-size:300% 300%;
  animation:bgShift 12s linear infinite;
  color:var(--text-primary);
  overflow-x:hidden;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
}
@keyframes bgShift{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
#appContainer{opacity:0;transition:opacity 0.6s;}
header{
  display:flex;align-items:center;justify-content:center;gap:16px;
  padding:24px 20px;
  backdrop-filter:blur(20px) saturate(180%);
  background:rgba(10,14,39,0.75);
  border-bottom:1px solid rgba(255,255,255,0.1);
  position:sticky;top:0;z-index:10;
  box-shadow:var(--shadow-md);
}
.logo{
  width:56px;height:56px;border-radius:14px;
  background:linear-gradient(135deg,#0b74d1,#a11ad8);
  color:#fff;
  display:flex;align-items:center;justify-content:center;
  font-weight:800;font-size:20px;
  cursor:pointer;
  box-shadow:var(--shadow-md);
  transition:all 0.3s ease;
}
.logo:hover{transform:scale(1.05) rotate(5deg);box-shadow:var(--shadow-lg);}
header h1{margin:0;font-size:22px;font-weight:700;color:var(--text-primary);letter-spacing:-0.5px;}
.tabs{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;padding:20px;backdrop-filter:blur(20px) saturate(180%);background:rgba(10,14,39,0.6);border-bottom:1px solid rgba(255,255,255,0.08);position:sticky;top:104px;z-index:9;box-shadow:var(--shadow-sm);}
.tab{background:rgba(255,255,255,0.08);color:var(--text-secondary);border:none;padding:12px 20px;border-radius:10px;font-weight:600;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);font-size:14px;position:relative;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(10px);}
.tab:hover{background:rgba(255,255,255,0.15);transform:translateY(-2px);box-shadow:var(--shadow-md);color:var(--text-primary);}
.tab.active{background:linear-gradient(135deg,rgba(11,116,209,0.3),rgba(161,26,216,0.3));color:var(--text-primary);box-shadow:var(--shadow-md);border-color:rgba(255,255,255,0.2);}
.tab-badge{position:absolute;top:-6px;right:-6px;background:var(--accent3);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;}
.tab-content{display:none;animation:fadeIn 0.3s ease;}
.tab-content.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.container{max-width:1200px;margin:26px auto;padding:0 20px 80px;}
.controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;}
input[type=text],input[type=number],select{min-width:220px;max-width:420px;padding:14px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.08);color:var(--text-primary);outline:none;font-size:14px;transition:all 0.3s;backdrop-filter:blur(10px);}
input[type=text]:focus,input[type=number]:focus,select:focus{border-color:rgba(11,116,209,0.5);background:rgba(255,255,255,0.12);box-shadow:0 0 0 3px rgba(11,116,209,0.1);}
input::placeholder{color:rgba(255,255,255,0.5);}
select{color:var(--text-primary);cursor:pointer;}
select option{background:#1a1a2e;color:#fff;}
.btn{background:linear-gradient(135deg,rgba(11,116,209,0.8),rgba(161,26,216,0.8));color:#fff;border:none;padding:14px 24px;border-radius:12px;font-weight:700;font-size:14px;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);box-shadow:var(--shadow-md);letter-spacing:0.3px;}
.btn:hover{transform:translateY(-3px);box-shadow:var(--shadow-lg);background:linear-gradient(135deg,rgba(11,116,209,1),rgba(161,26,216,1));}
.btn:active{transform:translateY(-1px);}
.btn-small{padding:6px 10px;font-size:12px;}
.btn-fav{position:absolute;right:10px;top:10px;background:rgba(255,255,255,0.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;}
.btn-fav:hover{background:rgba(255,255,255,0.3);transform:scale(1.1);}
.btn-fav.favorited{background:var(--accent3);color:#fff;}
.calendar{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;}
.card{border-radius:16px;padding:18px;min-height:140px;position:relative;color:var(--text-primary);box-shadow:var(--shadow-lg);transition:all 0.3s cubic-bezier(0.4,0,0.2,1);overflow:hidden;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px);background:linear-gradient(135deg,rgba(11,116,209,0.15),rgba(161,26,216,0.15));}
.card:hover{transform:translateY(-8px) scale(1.02);box-shadow:var(--shadow-xl);border-color:rgba(255,255,255,0.2);}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);opacity:0;transition:opacity 0.3s;}
.card:hover::before{opacity:1;}
.num{font-weight:800;margin-bottom:8px;}
.short{font-size:14px;line-height:1.4;color:rgba(255,255,255,0.95);}
.tooltip{position:absolute;left:12px;top:10px;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .18s;}
.card:hover .tooltip{opacity:1;}
.search-box{width:100%;max-width:600px;margin:0 auto 20px;position:relative;}
.search-box input{width:100%;padding-right:40px;}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0.6;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0;}
.stat-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center;backdrop-filter:blur(10px);}
.stat-value{font-size:32px;font-weight:800;margin:8px 0;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.stat-label{font-size:14px;opacity:0.9;}
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0;}
.setting-item{background:rgba(255,255,255,0.08);border-radius:10px;padding:16px;}
.setting-item label{display:block;margin-bottom:8px;font-weight:600;font-size:14px;}
.quick-idea-box{background:rgba(255,255,255,0.1);border-radius:14px;padding:24px;margin:20px auto;max-width:700px;text-align:center;backdrop-filter:blur(10px);}
.quick-idea-box h3{margin:0 0 16px;font-size:20px;}
.idea-display{background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;margin:16px 0;text-align:left;}
.idea-display .idea-title{font-size:18px;font-weight:700;margin-bottom:12px;color:#fff;}
.idea-display .idea-desc{font-size:14px;line-height:1.6;opacity:0.95;}
.empty-state{text-align:center;padding:60px 20px;opacity:0.7;}
.empty-state-icon{font-size:48px;margin-bottom:16px;}
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity 0.5s ease;}
.modal.visible{display:flex;opacity:1;}
.panel{background:#fff;border-radius:12px;max-width:820px;width:92%;max-height:86%;overflow:auto;padding:22px;position:relative;color:#071226;transform:translateY(20px);transition:transform 0.4s ease;}
.modal.visible .panel{transform:translateY(0);}
.panel h2{margin:0 0 8px;font-size:18px;}
.panel p{margin:8px 0 0;color:#24303b;line-height:1.6;}
.close{position:absolute;right:12px;top:12px;border:none;background:transparent;font-size:20px;cursor:pointer;font-weight:700;}
.copy-btn{position:absolute;right:12px;bottom:12px;border:none;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
.share-btn{position:absolute;right:80px;bottom:12px;border:none;background:rgba(11,116,209,0.8);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
.loadingOverlay{display:none;position:fixed;left:0;top:0;width:100%;height:100%;z-index:2000;align-items:center;justify-content:center;flex-direction:column;background:radial-gradient(circle at center,#001830,#000);transition:transform 0.5s ease,opacity 0.5s ease;}
.loadingOverlay.hidden{transform:translateY(-100%);opacity:0;}
.loadingCard{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));border-radius:14px;padding:18px;width:420px;max-width:92%;text-align:center;box-shadow:0 20px 70px rgba(2,8,23,0.5);}
.loadingCard h3{margin:0 0 8px;font-size:18px;color:#fff;}
.loadingInfo{font-size:13px;color:rgba(255,255,255,0.9);margin-bottom:12px;}
.progress{height:10px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;}
.progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);transition:width .9s linear;}
</style>
</head>
<body>
<div id="appContainer">
<header>
  <div class="logo" id="logoBtn">AGD</div>
  <h1>A Game a Day ‚Äî Ultra AI Edition</h1>
</header>

<div class="tabs">
  <button class="tab active" data-tab="generator">üéÆ Generator</button>
  <button class="tab" data-tab="quick">‚ö° Quick Idea</button>
  <button class="tab" data-tab="favorites">‚≠ê Favorites<span class="tab-badge" id="favBadge" style="display:none;">0</span></button>
  <button class="tab" data-tab="history">üìú History</button>
  <button class="tab" data-tab="stats">üìä Stats</button>
  <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
</div>

<!-- Generator Tab -->
<div class="tab-content active" id="generator">
  <div class="container">
    <div class="controls">
      <input id="titleInput" type="text" placeholder="Game title (optional)">
      <input id="descInput" type="text" placeholder="Short description (optional)">
      <button class="btn" id="generateBtn">Generate Ideas</button>
    </div>
    <div class="search-box">
      <input id="searchInput" type="text" placeholder="üîç Search ideas...">
    </div>
    <div class="calendar" id="calendar"></div>
    <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
      <button class="btn" id="downloadBtn">Download (.txt)</button>
      <button class="btn" id="downloadJsonBtn">Download (.json)</button>
      <button class="btn" id="downloadCsvBtn">Download (.csv)</button>
    </div>
  </div>
</div>

<!-- Quick Idea Tab -->
<div class="tab-content" id="quick">
  <div class="container">
    <div class="quick-idea-box">
      <h3>Get a Random Game Idea Instantly</h3>
      <button class="btn" id="quickGenerateBtn" style="margin-bottom:20px;">Generate Random Idea</button>
      <div id="quickIdeaDisplay" style="display:none;">
        <div class="idea-display">
          <div class="idea-title" id="quickTitle"></div>
          <div class="idea-desc" id="quickDesc"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
          <button class="btn btn-small" id="quickFavoriteBtn">‚≠ê Favorite</button>
          <button class="btn btn-small" id="quickCopyBtn">üìã Copy</button>
          <button class="btn btn-small" id="quickShareBtn">üîó Share</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Favorites Tab -->
<div class="tab-content" id="favorites">
  <div class="container">
    <div class="search-box">
      <input id="favSearchInput" type="text" placeholder="üîç Search favorites...">
    </div>
    <div class="calendar" id="favoritesContainer"></div>
    <div id="favEmptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">‚≠ê</div>
      <p>No favorites yet. Start favoriting ideas you love!</p>
    </div>
  </div>
</div>

<!-- History Tab -->
<div class="tab-content" id="history">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
      <h3 style="margin:0;">Generation History</h3>
      <button class="btn btn-small" id="clearHistoryBtn">Clear History</button>
    </div>
    <div id="historyContainer"></div>
    <div id="historyEmptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üìú</div>
      <p>No generation history yet. Start generating ideas!</p>
    </div>
  </div>
</div>

<!-- Stats Tab -->
<div class="tab-content" id="stats">
  <div class="container">
    <h3 style="text-align:center;margin-bottom:24px;">Your Statistics</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Ideas Generated</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Favorite Ideas</div>
        <div class="stat-value" id="statFavorites">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Generations</div>
        <div class="stat-value" id="statGenerations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Most Used Genre</div>
        <div class="stat-value" id="statGenre" style="font-size:20px;">-</div>
      </div>
    </div>
    <div style="margin-top:32px;text-align:center;">
      <button class="btn" id="refreshStatsBtn">Refresh Stats</button>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="settings">
  <div class="container">
    <h3 style="text-align:center;margin-bottom:24px;">Settings</h3>
    <div class="settings-grid">
      <div class="setting-item">
        <label>Number of Days to Generate</label>
        <input type="number" id="settingDays" min="1" max="365" value="30">
      </div>
      <div class="setting-item">
        <label>Default Export Format</label>
        <select id="settingExport">
          <option value="txt">Text (.txt)</option>
          <option value="json">JSON (.json)</option>
          <option value="csv">CSV (.csv)</option>
        </select>
      </div>
      <div class="setting-item">
        <label>Auto-save to History</label>
        <select id="settingAutoSave">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
      <div class="setting-item">
        <label>OpenAI API Key (for AI-powered ideas)</label>
        <input type="password" id="settingApiKey" placeholder="sk-..." style="width:100%;">
        <div style="font-size:12px;opacity:0.8;margin-top:8px;">Get your key at <a href="https://platform.openai.com/api-keys" target="_blank" style="color:#0b74d1;">platform.openai.com</a>. Leave empty for random generation.</div>
      </div>
      <div class="setting-item">
        <label>AI Model</label>
        <select id="settingAiModel">
          <option value="gpt-4o-mini">GPT-4o Mini (Fast & Affordable)</option>
          <option value="gpt-4o">GPT-4o (Best Quality)</option>
          <option value="gpt-3.5-turbo">GPT-3.5 Turbo (Fastest)</option>
        </select>
      </div>
    </div>
    <div style="margin-top:24px;text-align:center;">
      <button class="btn" id="saveSettingsBtn">Save Settings</button>
      <button class="btn" id="resetSettingsBtn" style="margin-left:12px;">Reset to Defaults</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <button class="close" id="closeModal">√ó</button>
    <div id="panelContent"></div>
    <button class="share-btn" id="shareBtn">Share</button>
    <button class="copy-btn" id="copyBtn">Copy</button>
  </div>
</div>

<!-- Loading -->
<div class="loadingOverlay" id="loading">
  <div class="loadingCard">
    <h3>Generating ideas</h3>
    <div class="loadingInfo" id="loadingSub">Preparing...</div>
    <div class="progress"><i id="progressBar"></i></div>
    <div class="loadingInfo" id="loadingPct">0%</div>
  </div>
</div>
</div>

<script>
function sleep(ms){return new Promise(res=>setTimeout(res,ms));}
function rand(arr){return arr[Math.floor(Math.random()*arr.length)];}

const genres=['RPG','Platformer','Horror','Roguelike','Shooter','Simulation','Strategy','Mystery','Rhythm','Adventure','Puzzle','Metroidvania','Action','Stealth','Card','Sandbox','City Builder','VR','AR','Narrative','Survival','Fantasy','Sci-Fi','Historical','Cyberpunk','Noir','Western','Post-Apocalyptic','Space','Comedy','Slice of Life'];
const gameSettings=['a floating sky city','a haunted carnival','a neon cyber-metro','a quiet mountain village','an underwater research base','a desert planet outpost','a post-war bunker','a futuristic Tokyo district','a cursed forest','a digital dream world','an abandoned theme park','a medieval academy','a crumbling megacity','a pirate skyship','a moon colony','a misty swamp town','a massive AI core','a gothic cathedral','a snowy tundra settlement','a sunken city of glass'];
const mechanics=['time-loop progression','deck-building choices','squad management','gravity-based puzzles','musical combat','resource crafting','turn-based tactics','stealth infiltration','dialogue branching','combat rhythm sync','shape-shifting abilities','ecosystem simulation','roguelike dungeons','card fusion system','emotion-based AI companions','multi-timeline switching','reputation diplomacy','building physics simulation','team synergy combos','shadow possession'];
const storyHooks=['you awaken with your memories rewritten','your twin controls your shadow self','a forgotten song reshapes reality','a virus spreads through dreams','you lead refugees across broken dimensions','your choices rewrite past events','a rival mirrors your every move','you must uncover who programmed your fate','a city runs on bottled emotions','you hunt your future self','time fractures each dawn','your world ends every midnight','an AI writes new laws daily','the moon vanishes every night','you rebuild a civilization from echoes','magic runs through sound frequencies'];

// Expanded keyword system - generates millions of combinations
const genreBase=['RPG','Platformer','Horror','Roguelike','Shooter','Simulation','Strategy','Mystery','Rhythm','Adventure','Puzzle','Metroidvania','Action','Stealth','Card','Sandbox','City Builder','VR','AR','Narrative','Survival','Fantasy','Sci-Fi','Historical','Cyberpunk','Noir','Western','Post-Apocalyptic','Space','Comedy','Slice of Life','Tactical','Racing','Fighting','Sports','Educational','Idle','Incremental','Tower Defense','MOBA','Battle Royale','MMO','RTS','Turn-Based','Real-Time','Co-op','Competitive','Casual','Hardcore','Indie','AAA','Retro','Modern','Futuristic','Medieval','Steampunk','Dieselpunk','Biopunk','Solarpunk','Atompunk','Clockpunk','Dungeon Crawler','Souls-like','Roguelite','Bullet Hell','Twin-Stick','Top-Down','Isometric','Side-Scrolling','First-Person','Third-Person','Open World','Linear','Procedural','Hand-Crafted','Narrative-Driven','Gameplay-Focused','Story-Rich','Character-Driven','World-Building','Exploration','Combat','Puzzle-Solving','Crafting','Building','Trading','Farming','Cooking','Fishing','Hunting','Gathering','Mining','Crafting','Alchemy','Enchanting','Taming','Breeding','Farming','Trading','Diplomacy','Warfare','Exploration','Discovery','Survival','Crafting','Building','Social','Multiplayer','Single-Player','Cooperative','Competitive','Asymmetric','Symmetric','Team-Based','Free-For-All','Battle','Arena','Campaign','Story Mode','Endless Mode','Challenge Mode','Time Attack','Speedrun','Completionist','Collectathon','Metroidvania','Souls-like','Roguelike','Roguelite','Procedural','Hand-Crafted','Narrative','Gameplay','Combat','Puzzle','Exploration','Crafting','Building','Trading','Social','Multiplayer','Single-Player'];
const settingBase=['floating sky city','haunted carnival','neon cyber-metro','quiet mountain village','underwater research base','desert planet outpost','post-war bunker','futuristic Tokyo district','cursed forest','digital dream world','abandoned theme park','medieval academy','crumbling megacity','pirate skyship','moon colony','misty swamp town','massive AI core','gothic cathedral','snowy tundra settlement','sunken city of glass','orbital station','dimensional rift','time-lost temple','quantum realm','neural network','data fortress','memory palace','dreamscape','nightmare dimension','void between worlds','celestial observatory','ancient library','forbidden archive','crystal cavern','lava forge','ice citadel','storm tower','lightning spire','thunder peak','wind valley','earth core','fire mountain','water temple','air sanctuary','spirit realm','shadow dimension','light domain','dark abyss','bright void','colorless void','rainbow bridge','prism palace','mirror maze','echo chamber','silence cathedral','sound garden','music hall','rhythm temple','harmony sanctuary','discord fortress','chaos realm','order citadel','balance tower','imbalance abyss','stability core','instability zone','reality anchor','unreality void','truth beacon','lie labyrinth','honor hall','dishonor pit','virtue temple','vice den','purity shrine','corruption nest','sanctity altar','profanity chamber','divinity throne','mortality grave','immortality fountain','eternity gate','temporality clock','spatiality portal','dimensionality rift','parallelity mirror','alternativity switch','mirrority reflection','twistity distortion','straightity path','curvity arc','linearity line','circularity circle','spirality spiral','fractality fractal','chaoticity chaos','orderity order','randomity random','determinity determination','freedomity freedom','boundity bound','unboundity unbound','limitedity limited','unlimitedity unlimited','finiteity finite','infiniteity infinite','reality real','virtuality virtual','digitality digital','analogity analog','organicity organic','syntheticity synthetic','naturality natural','artificiality artificial','livingity living','deadity dead','undeadity undead','immortality immortal','mortality mortal','temporality temporal','eternality eternal','briefity brief','lastingity lasting','momentarity momentary','permanity permanent','tempority temporary','fixedity fixed','fluidity fluid','solidity solid','liquidity liquid','gaseity gaseous','plasmaity plasma','energyity energy','matterity matter','antimatterity antimatter'];
const settingPrefixes=['a','an','the','your','this','that','an ancient','a forgotten','a lost','a hidden','a secret','a mysterious','a legendary','an abandoned','a ruined','a thriving','a bustling','a quiet','a peaceful','a war-torn','a post-apocalyptic','a pre-apocalyptic','a futuristic','a retro-futuristic','a cyberpunk','a steampunk','a dieselpunk','a biopunk','a solarpunk','a medieval','a modern','a contemporary','an alternate','a parallel','a mirror','a twisted','a corrupted','a purified','a transformed','a mutated','a evolved','a devolved','a hybrid','a fusion','a combination','a blend','a mix','a synthesis','a quantum','a temporal','a spatial','a dimensional','a parallel','an alternate','a mirror','a twisted','a corrupted','a purified','a transformed','a mutated','an evolved','a devolved','a hybrid','a fusion','a combination','a blend','a mix','a synthesis','a quantum','a temporal','a spatial','a dimensional','a parallel','an alternate','a mirror','a twisted','a corrupted','a purified','a transformed','a mutated','an evolved','a devolved','a hybrid','a fusion','a combination','a blend','a mix','a synthesis'];
const mechanicBase=['time-loop progression','deck-building choices','squad management','gravity-based puzzles','musical combat','resource crafting','turn-based tactics','stealth infiltration','dialogue branching','combat rhythm sync','shape-shifting abilities','ecosystem simulation','roguelike dungeons','card fusion system','emotion-based AI companions','multi-timeline switching','reputation diplomacy','building physics simulation','team synergy combos','shadow possession'];
const hookBase=['you awaken with your memories rewritten','your twin controls your shadow self','a forgotten song reshapes reality','a virus spreads through dreams','you lead refugees across broken dimensions','your choices rewrite past events','a rival mirrors your every move','you must uncover who programmed your fate','a city runs on bottled emotions','you hunt your future self','time fractures each dawn','your world ends every midnight','an AI writes new laws daily','the moon vanishes every night','you rebuild a civilization from echoes','magic runs through sound frequencies'];

function getExpandedGenre(){return rand(genreBase);}
function getExpandedSetting(){return rand(settingPrefixes)+' '+rand(settingBase);}
function getExpandedMechanic(){return rand(mechanicBase);}
function getExpandedHook(){return rand(hookBase);}

// Storage helpers
function getStorage(key,defaultVal=[]){const v=localStorage.getItem(key);return v?JSON.parse(v):defaultVal;}
function setStorage(key,val){localStorage.setItem(key,JSON.stringify(val));}

// State
const appContainer = document.getElementById('appContainer');
const calendarEl=document.getElementById('calendar');
const modal=document.getElementById('modal');
const panel=document.getElementById('panelContent');
const copyBtn=document.getElementById('copyBtn');
const shareBtn=document.getElementById('shareBtn');
const closeModalBtn=document.getElementById('closeModal');
const logoBtn=document.getElementById('logoBtn');
const loading=document.getElementById('loading');
const progressBar=document.getElementById('progressBar');
const loadingPct=document.getElementById('loadingPct');
let currentIdeas=[];
let currentModalIdea=null;
let currentModalDay=0;

// Settings
let settings={days:30,export:'txt',autoSave:true,apiKey:'',aiModel:'gpt-4o-mini'};
function loadSettings(){const s=getStorage('settings',settings);settings={...settings,...s};}
function saveSettings(){setStorage('settings',settings);}
function applySettings(){
  const daysEl=document.getElementById('settingDays');
  const exportEl=document.getElementById('settingExport');
  const autoSaveEl=document.getElementById('settingAutoSave');
  const apiKeyEl=document.getElementById('settingApiKey');
  const aiModelEl=document.getElementById('settingAiModel');
  if(daysEl)daysEl.value=settings.days;
  if(exportEl)exportEl.value=settings.export;
  if(autoSaveEl)autoSaveEl.value=settings.autoSave.toString();
  if(apiKeyEl)apiKeyEl.value=settings.apiKey||'';
  if(aiModelEl)aiModelEl.value=settings.aiModel||'gpt-4o-mini';
}

// Tab switching
function initTabs(){
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if(tab.dataset.tab==='favorites')renderFavorites();
      if(tab.dataset.tab==='history')renderHistory();
      if(tab.dataset.tab==='stats')updateStats();
    };
  });
}

// Initialize on load
window.addEventListener('load',()=>{
  loadSettings();
  applySettings();
  initTabs();
  appContainer.style.opacity='1';
  updateFavBadge();
  renderFavorites();
  renderHistory();
  updateStats();
});

// Modal
function fadeOutModal(){
  modal.style.opacity='0';
  setTimeout(()=>{modal.style.display='none';modal.classList.remove('visible');modal.style.opacity='';},500);
}
closeModalBtn.onclick=()=>fadeOutModal();
modal.onclick=e=>{if(e.target===modal)fadeOutModal();};

copyBtn.onclick=()=>{
  if(!currentModalIdea)return;
  const text=`${currentModalIdea.short}\n\n${currentModalIdea.explanation}`;
  navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
};

shareBtn.onclick=()=>{
  if(!currentModalIdea)return;
  const text=`üéÆ Game Idea: ${currentModalIdea.short}\n\n${currentModalIdea.explanation}`;
  if(navigator.share){
    navigator.share({title:'Game Idea',text:text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
  }
};

// Logo resets app
logoBtn.onclick = () => {
  appContainer.style.opacity='0';
  setTimeout(()=>{
    calendarEl.innerHTML='';
    currentIdeas=[];
    document.getElementById('titleInput').value='';
    document.getElementById('descInput').value='';
    document.getElementById('searchInput').value='';
    fadeOutModal();
    appContainer.style.opacity='1';
  },600);
};

async function showLoading(seconds,text){
  loading.style.display='flex';
  document.getElementById('loadingSub').textContent=text;
  progressBar.style.width='0%';
  loadingPct.textContent='0%';
  for(let i=1;i<=seconds;i++){
    progressBar.style.width=Math.min(100,Math.round(i/seconds*100))+'%';
    loadingPct.textContent=Math.min(100,Math.round(i/seconds*100))+'%';
    await sleep(200);
  }
}

async function generateAIIdea(title,desc){
  if(!settings.apiKey||!settings.apiKey.trim())return null;
  try{
    const prompt=`Generate a unique, creative game idea. ${title?`Title preference: "${title}". `:''}${desc?`Description: "${desc}". `:''}Return a JSON object with: {"genres":["genre1","genre2"],"setting":"unique game world","mechanic":"core gameplay mechanic","hook":"narrative premise","title":"game title","short":"brief one-line description","explanation":"detailed 2-3 sentence explanation"}. Be creative and original.`;
    const response=await fetch('https://api.openai.com/v1/chat/completions',{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization':`Bearer ${settings.apiKey.trim()}`
      },
      body:JSON.stringify({
        model:settings.aiModel||'gpt-4o-mini',
        messages:[{role:'user',content:prompt}],
        temperature:0.9,
        max_tokens:300
      })
    });
    if(!response.ok)throw new Error('API error');
    const data=await response.json();
    const content=data.choices[0].message.content.trim();
    let idea;
    try{
      idea=JSON.parse(content);
    }catch{
      const jsonMatch=content.match(/\{[\s\S]*\}/);
      if(jsonMatch)idea=JSON.parse(jsonMatch[0]);
      else throw new Error('Invalid response format');
    }
    const genres=Array.isArray(idea.genres)?idea.genres:[idea.genres||'Adventure'];
    const short=`${genres.join(" / ")} ‚Äî Set in ${idea.setting||'a unique world'}. Core mechanic: ${idea.mechanic||'engaging gameplay'}. Story hook: ${idea.hook||'an intriguing premise'}. Title: "${idea.title||'Untitled Game'}".`;
    return {
      short:idea.short||short,
      explanation:idea.explanation||`This concept mixes ${genres.join(', ')} elements in ${idea.setting}. The core loop revolves around ${idea.mechanic}, and the main narrative tension is: ${idea.hook}. The name "${idea.title||'Untitled'}" ties the style and mood together.`,
      primary:genres[0],
      genres:genres,
      setting:idea.setting||'a unique world',
      mechanic:idea.mechanic||'engaging gameplay',
      hook:idea.hook||'an intriguing premise',
      title:idea.title||'Untitled Game',
      id:Date.now()+Math.random(),
      aiGenerated:true
    };
  }catch(err){
    console.error('AI generation error:',err);
    return null;
  }
}

function buildIdea(title, desc){
  const g=[getExpandedGenre(),getExpandedGenre(),getExpandedGenre()].filter((v,i,a)=>a.indexOf(v)===i).slice(0,rand([1,2,3]));
  const s=getExpandedSetting(); const m=getExpandedMechanic(); const h=getExpandedHook();
  const adjectives=["Crimson","Neon","Shadow","Silent","Echo","Phantom","Eternal","Crystal","Solar","Iron","Velvet","Dream","Infinite","Midnight","Azure","Golden","Arcane","Forgotten","Digital","Frozen","Titan","Spectral","Burning","Emerald","Void","Celestial","Primal","Ancient","Mystic","Ethereal","Cosmic","Quantum","Neon","Cyber","Bio","Nano","Hyper","Ultra","Mega","Super","Prime","Alpha","Omega","Zero","Null","Void","Dark","Light","Bright","Dim","Faded","Vibrant","Muted","Bold","Subtle","Raw","Refined","Pure","Corrupt","Sacred","Profane","Divine","Demonic","Heavenly","Infernal","Eternal","Temporal","Spatial","Dimensional","Parallel","Alternate","Mirror","Twisted","Straight","Curved","Linear","Circular","Spiral","Fractal","Chaotic","Ordered","Random","Determined","Free","Bound","Unbound","Limited","Unlimited","Finite","Infinite","Real","Virtual","Digital","Analog","Organic","Synthetic","Natural","Artificial","Living","Dead","Undead","Immortal","Mortal","Temporal","Eternal","Brief","Lasting","Momentary","Permanent","Temporary","Fixed","Fluid","Solid","Liquid","Gaseous","Plasma","Energy","Matter","Antimatter","Dark","Light","Bright","Dim","Luminous","Opaque","Transparent","Translucent","Visible","Invisible","Tangible","Intangible","Physical","Metaphysical","Material","Immaterial","Corporeal","Incorporeal","Solid","Hollow","Dense","Sparse","Thick","Thin","Wide","Narrow","Broad","Tight","Loose","Taut","Slack","Rigid","Flexible","Stiff","Supple","Hard","Soft","Firm","Gentle","Rough","Smooth","Coarse","Fine","Crude","Refined","Raw","Processed","Natural","Artificial","Organic","Inorganic","Living","Nonliving","Animate","Inanimate","Sentient","Insentient","Conscious","Unconscious","Aware","Unaware","Awake","Asleep","Alive","Dead","Undead","Immortal","Mortal","Eternal","Temporal","Infinite","Finite","Unlimited","Limited","Boundless","Bounded","Free","Restricted","Open","Closed","Accessible","Inaccessible","Available","Unavailable","Present","Absent","Here","There","Near","Far","Close","Distant","Local","Remote","Proximate","Distant","Adjacent","Separate","Connected","Disconnected","Linked","Unlinked","Joined","Separated","United","Divided","Whole","Partial","Complete","Incomplete","Finished","Unfinished","Done","Undone","Accomplished","Unaccomplished","Achieved","Unachieved","Succeeded","Failed","Won","Lost","Victorious","Defeated","Triumphant","Vanquished","Conquered","Unconquered","Dominant","Submissive","Powerful","Powerless","Strong","Weak","Mighty","Feeble","Robust","Fragile","Sturdy","Delicate","Tough","Tender","Hardy","Sensitive","Resilient","Vulnerable","Invulnerable","Indestructible","Destructible","Durable","Perishable","Lasting","Ephemeral","Permanent","Temporary","Enduring","Fleeting","Stable","Unstable","Steady","Unsteady","Firm","Unfirm","Solid","Unsolid","Secure","Insecure","Safe","Unsafe","Protected","Unprotected","Defended","Undefended","Guarded","Unguarded","Shielded","Unshielded","Armored","Unarmored","Fortified","Unfortified","Reinforced","Unreinforced","Strengthened","Weakened","Enhanced","Diminished","Improved","Deteriorated","Upgraded","Downgraded","Elevated","Lowered","Raised","Dropped","Lifted","Fallen","Ascended","Descended","Risen","Sunk","Floated","Sank","Soared","Plummeted","Climbed","Fell","Jumped","Landed","Leaped","Bounded","Sprung","Sprang","Bounced","Rebounded","Reflected","Refracted","Absorbed","Emitted","Radiated","Conducted","Insulated","Isolated","Connected","Disconnected","Linked","Unlinked","Joined","Separated","United","Divided","Merged","Split","Combined","Separated","Fused","Fissioned","Integrated","Disintegrated","Assembled","Disassembled","Constructed","Destroyed","Built","Demolished","Created","Annihilated","Formed","Deformed","Shaped","Misshapen","Molded","Unmolded","Carved","Uncarved","Sculpted","Unsculpted","Crafted","Uncrafted","Made","Unmade","Produced","Unproduced","Generated","Ungenerated","Manufactured","Unmanufactured","Fabricated","Unfabricated","Constructed","Deconstructed","Built","Unbuilt","Erected","Demolished","Raised","Razed","Established","Disestablished","Founded","Dissolved","Instituted","Abolished","Created","Destroyed","Formed","Deformed","Shaped","Misshapen","Molded","Unmolded","Carved","Uncarved","Sculpted","Unsculpted","Crafted","Uncrafted","Made","Unmade","Produced","Unproduced","Generated","Ungenerated","Manufactured","Unmanufactured","Fabricated","Unfabricated"];
  const nouns=["Odyssey","Protocol","Frontier","Legacy","Descent","Haven","Circuit","Genesis","Chronicle","Abyss","Empire","Horizon","Velocity","Tide","Sanctum","Hollow","Labyrinth","Catalyst","Pulse","Voyage","Realm","Shift","Beacon","Domain","Nexus","Vortex","Matrix","Grid","Network","System","Framework","Structure","Architecture","Design","Pattern","Template","Blueprint","Schema","Model","Prototype","Archetype","Paradigm","Exemplar","Standard","Benchmark","Criterion","Measure","Metric","Gauge","Scale","Range","Scope","Extent","Reach","Span","Width","Breadth","Depth","Height","Length","Distance","Proximity","Vicinity","Neighborhood","Region","Area","Zone","Territory","Domain","Realm","Kingdom","Empire","Nation","Country","State","Province","County","District","Precinct","Ward","Quarter","Section","Segment","Part","Portion","Fraction","Percentage","Ratio","Proportion","Share","Allotment","Quota","Allowance","Ration","Portion","Share","Part","Piece","Fragment","Segment","Section","Division","Subdivision","Category","Class","Type","Kind","Sort","Variety","Species","Genus","Family","Order","Phylum","Kingdom","Domain","Realm","Sphere","Orb","Globe","Ball","Circle","Ring","Loop","Coil","Spiral","Helix","Curve","Arc","Bend","Turn","Twist","Rotation","Revolution","Orbit","Path","Trajectory","Course","Route","Way","Road","Pathway","Track","Trail","Lane","Street","Avenue","Boulevard","Highway","Freeway","Expressway","Turnpike","Tollway","Causeway","Bridge","Overpass","Underpass","Tunnel","Subway","Metro","Railway","Railroad","Train","Locomotive","Engine","Motor","Machine","Device","Apparatus","Instrument","Tool","Implement","Utensil","Gadget","Contraption","Mechanism","Contrivance","Invention","Innovation","Creation","Product","Artifact","Object","Item","Thing","Entity","Being","Creature","Organism","Lifeform","Species","Specimen","Sample","Example","Instance","Case","Occurrence","Event","Incident","Episode","Scene","Act","Chapter","Section","Part","Segment","Division","Subdivision","Category","Class","Type","Kind","Sort","Variety","Species","Genus","Family","Order","Phylum","Kingdom","Domain","Realm","Sphere","Orb","Globe","Ball","Circle","Ring","Loop","Coil","Spiral","Helix","Curve","Arc","Bend","Turn","Twist","Rotation","Revolution","Orbit","Path","Trajectory","Course","Route","Way","Road","Pathway","Track","Trail","Lane","Street","Avenue","Boulevard","Highway","Freeway","Expressway","Turnpike","Tollway","Causeway","Bridge","Overpass","Underpass","Tunnel","Subway","Metro","Railway","Railroad","Train","Locomotive","Engine","Motor","Machine","Device","Apparatus","Instrument","Tool","Implement","Utensil","Gadget","Contraption","Mechanism","Contrivance","Invention","Innovation","Creation","Product","Artifact","Object","Item","Thing","Entity","Being","Creature","Organism","Lifeform","Species","Specimen","Sample","Example","Instance","Case","Occurrence","Event","Incident","Episode","Scene","Act","Chapter","Section","Part","Segment","Division","Subdivision","Category","Class","Type","Kind","Sort","Variety"];
  function smartTitleFrom(descText){
    const d=(descText||"").toLowerCase();
    if(d.includes("fun")||d.includes("happy"))return rand(["Joy Horizon","Color Quest","Happy Fields"]);
    if(d.includes("dark")||d.includes("scary")||d.includes("fear"))return rand(["Shadow Genesis","Phantom Descent","Eclipse Veil"]);
    if(d.includes("space")||d.includes("future")||d.includes("tech"))return rand(["Neon Frontier","Echo Circuit","Digital Odyssey"]);
    if(d.includes("magic")||d.includes("fantasy")||d.includes("mystic"))return rand(["Arcane Horizon","Crystal Haven","Forgotten Realm"]);
    if(d.includes("war")||d.includes("fight")||d.includes("battle"))return rand(["Iron Protocol","Crimson Empire","Tactical Horizon"]);
    return rand(adjectives)+" "+rand(nouns);
  }
  const focus=title?.trim()?title.trim():(desc?.trim()?smartTitleFrom(desc):smartTitleFrom(""));
  const short=`${g.join(" / ")} ‚Äî Set in ${s}. Core mechanic: ${m}. Story hook: ${h}. Title: "${focus}".`;
  const explanation=`This concept mixes ${g.join(', ')} elements in ${s}. The core loop revolves around ${m}, and the main narrative tension is: ${h}. The name "${focus}" ties the style and mood together for a cohesive creative theme.`;
  return {short,explanation,primary:g[0],genres:g,setting:s,mechanic:m,hook:h,title:focus,id:Date.now()+Math.random(),aiGenerated:false};
}

function createCard(idea,day,showFav=true){
  const card=document.createElement('div');
  card.className='card';
  card.dataset.ideaId=idea.id;
  const favs=getStorage('favorites',[]);
  const isFav=favs.some(f=>f.id===idea.id);
  card.style.background=`linear-gradient(180deg, #0b74d1, rgba(0,0,0,0.14))`;
  card.innerHTML=`<div class="num">${day?`Day ${day}`:'Idea'}</div><div class="short">${idea.short}</div><div class="tooltip">Click for details</div>${showFav?`<button class="btn-fav ${isFav?'favorited':''}" data-idea-id="${idea.id}">${isFav?'‚≠ê':'‚òÜ'}</button>`:''}`;
  card.onclick=(e)=>{if(!e.target.classList.contains('btn-fav'))openModal(idea,day);};
  if(showFav){
    const favBtn=card.querySelector('.btn-fav');
    favBtn.onclick=(e)=>{e.stopPropagation();toggleFavorite(idea);};
  }
  return card;
}

function openModal(idea,day){
  currentModalIdea=idea;
  currentModalDay=day;
  panel.innerHTML='';
  const h=document.createElement('h2');
  h.textContent=day?`Day ${day} ‚Äî ${idea.short}`:idea.short;
  const p=document.createElement('p');
  p.textContent=idea.explanation;
  panel.appendChild(h);
  panel.appendChild(p);
  modal.classList.add('visible');
  modal.style.display='flex';
}

function toggleFavorite(idea){
  let favs=getStorage('favorites',[]);
  const idx=favs.findIndex(f=>f.id===idea.id);
  if(idx>=0){
    favs.splice(idx,1);
    document.querySelectorAll(`[data-idea-id="${idea.id}"]`).forEach(btn=>{
      btn.classList.remove('favorited');
      btn.textContent='‚òÜ';
    });
  }else{
    favs.push(idea);
    document.querySelectorAll(`[data-idea-id="${idea.id}"]`).forEach(btn=>{
      btn.classList.add('favorited');
      btn.textContent='‚≠ê';
    });
  }
  setStorage('favorites',favs);
  updateFavBadge();
  if(document.getElementById('favorites').classList.contains('active'))renderFavorites();
}

function updateFavBadge(){
  const favs=getStorage('favorites',[]);
  const badge=document.getElementById('favBadge');
  if(favs.length>0){
    badge.textContent=favs.length;
    badge.style.display='flex';
  }else{
    badge.style.display='none';
  }
}

function renderFavorites(){
  const favs=getStorage('favorites',[]);
  const container=document.getElementById('favoritesContainer');
  const empty=document.getElementById('favEmptyState');
  container.innerHTML='';
  const searchTerm=document.getElementById('favSearchInput').value.toLowerCase();
  const filtered=favs.filter(f=>!searchTerm||f.short.toLowerCase().includes(searchTerm)||f.explanation.toLowerCase().includes(searchTerm));
  if(filtered.length===0){
    container.style.display='none';
    empty.style.display='block';
  }else{
    container.style.display='grid';
    empty.style.display='none';
    filtered.forEach((idea,i)=>{container.appendChild(createCard(idea,i+1,false));});
  }
}

function renderHistory(){
  const history=getStorage('history',[]);
  const container=document.getElementById('historyContainer');
  const empty=document.getElementById('historyEmptyState');
  container.innerHTML='';
  if(history.length===0){
    container.style.display='none';
    empty.style.display='block';
  }else{
    container.style.display='block';
    empty.style.display='none';
    history.reverse().forEach((entry,idx)=>{
      const div=document.createElement('div');
      div.style.background='rgba(255,255,255,0.08)';
      div.style.borderRadius='10px';
      div.style.padding='16px';
      div.style.marginBottom='12px';
      const date=new Date(entry.timestamp);
      div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:12px;"><div><strong>${date.toLocaleString()}</strong><div style="font-size:13px;opacity:0.8;margin-top:4px;">${entry.count} ideas generated</div></div><button class="btn btn-small" onclick="loadHistoryEntry(${history.length-1-idx})">Load</button></div>`;
      container.appendChild(div);
    });
  }
}

window.loadHistoryEntry=(idx)=>{
  const history=getStorage('history',[]);
  const entry=history[history.length-1-idx];
  if(entry){
    currentIdeas=entry.ideas;
    calendarEl.innerHTML='';
    currentIdeas.forEach((idea,i)=>{
      calendarEl.appendChild(createCard(idea,i+1));
    });
    document.querySelector('[data-tab="generator"]').click();
  }
};

function updateStats(){
  const history=getStorage('history',[]);
  const favs=getStorage('favorites',[]);
  let totalIdeas=0;
  const genreCount={};
  history.forEach(h=>{
    totalIdeas+=h.ideas.length;
    h.ideas.forEach(i=>{
      if(i.genres) i.genres.forEach(g=>{genreCount[g]=(genreCount[g]||0)+1;});
    });
  });
  document.getElementById('statTotal').textContent=totalIdeas;
  document.getElementById('statFavorites').textContent=favs.length;
  document.getElementById('statGenerations').textContent=history.length;
  const topGenre=Object.keys(genreCount).reduce((a,b)=>genreCount[a]>genreCount[b]?a:b,'-');
  document.getElementById('statGenre').textContent=topGenre;
}

async function generateAndRender(){
  const title=document.getElementById('titleInput').value;
  const desc=document.getElementById('descInput').value;
  const numDays=parseInt(settings.days)||30;
  const useAI=settings.apiKey&&settings.apiKey.trim();
  await showLoading(useAI?Math.max(2,numDays*0.5):Math.max(1,1),"Preparing your ideas...");
  loading.classList.add('hidden');
  await sleep(300);
  loading.style.display='none';
  loading.classList.remove('hidden');
  calendarEl.innerHTML='';
  currentIdeas=[];
  document.getElementById('loadingSub').textContent=useAI?'Generating AI-powered ideas...':'Generating ideas...';
  for(let i=0;i<numDays;i++){
    let idea;
    if(useAI){
      document.getElementById('loadingSub').textContent=`Generating idea ${i+1}/${numDays} with AI...`;
      idea=await generateAIIdea(title,desc);
      if(!idea)idea=buildIdea(title,desc);
    }else{
      idea=buildIdea(title,desc);
    }
    currentIdeas.push(idea);
    calendarEl.appendChild(createCard(idea,i+1));
    await sleep(useAI?200:10);
  }
  if(settings.autoSave){
    const history=getStorage('history',[]);
    history.push({timestamp:Date.now(),ideas:currentIdeas,count:currentIdeas.length,title,desc,aiUsed:useAI});
    if(history.length>50)history.shift();
    setStorage('history',history);
  }
  updateStats();
}

// Search
document.getElementById('searchInput').addEventListener('input',(e)=>{
  const term=e.target.value.toLowerCase();
  document.querySelectorAll('#calendar .card').forEach(card=>{
    const text=card.textContent.toLowerCase();
    card.style.display=!term||text.includes(term)?'block':'none';
  });
});

document.getElementById('favSearchInput').addEventListener('input',()=>{renderFavorites();});

// Quick Idea
document.getElementById('quickGenerateBtn').onclick=async ()=>{
  const btn=document.getElementById('quickGenerateBtn');
  btn.disabled=true;
  btn.textContent='Generating...';
  let idea;
  if(settings.apiKey&&settings.apiKey.trim()){
    const aiIdea=await generateAIIdea('','');
    idea=aiIdea||buildIdea('','');
  }else{
    idea=buildIdea('','');
  }
  document.getElementById('quickTitle').textContent=idea.short;
  document.getElementById('quickDesc').textContent=idea.explanation;
  document.getElementById('quickIdeaDisplay').style.display='block';
  const favBtn=document.getElementById('quickFavoriteBtn');
  const favs=getStorage('favorites',[]);
  const isFav=favs.some(f=>f.id===idea.id);
  favBtn.textContent=isFav?'‚≠ê Unfavorite':'‚≠ê Favorite';
  favBtn.onclick=()=>{toggleFavorite(idea);favBtn.textContent=favs.some(f=>f.id===idea.id)?'‚≠ê Unfavorite':'‚≠ê Favorite';};
  document.getElementById('quickCopyBtn').onclick=()=>{
    navigator.clipboard.writeText(`${idea.short}\n\n${idea.explanation}`).then(()=>{alert('Copied!');});
  };
  document.getElementById('quickShareBtn').onclick=()=>{
    const text=`üéÆ Game Idea: ${idea.short}\n\n${idea.explanation}`;
    if(navigator.share){
      navigator.share({title:'Game Idea',text:text}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
    }
  };
  btn.disabled=false;
  btn.textContent='Generate Random Idea';
};

// Export functions
document.getElementById('downloadBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  let txt='A Game a Day ‚Äî Ultra AI Edition\n\n';
  currentIdeas.forEach((it,i)=>{txt+=`Day ${i+1}:\n${it.short}\n${it.explanation}\n\n`;});
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

document.getElementById('downloadJsonBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  const json=JSON.stringify(currentIdeas,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

document.getElementById('downloadCsvBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  let csv='Day,Short Description,Full Explanation\n';
  currentIdeas.forEach((it,i)=>{csv+=`${i+1},"${it.short.replace(/"/g,'""')}","${it.explanation.replace(/"/g,'""')}"\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

// Settings
document.getElementById('saveSettingsBtn').onclick=()=>{
  settings.days=parseInt(document.getElementById('settingDays').value)||30;
  settings.export=document.getElementById('settingExport').value;
  settings.autoSave=document.getElementById('settingAutoSave').value==='true';
  settings.apiKey=document.getElementById('settingApiKey').value;
  settings.aiModel=document.getElementById('settingAiModel').value;
  saveSettings();
  alert('Settings saved!');
};

document.getElementById('resetSettingsBtn').onclick=()=>{
  settings={days:30,export:'txt',autoSave:true};
  applySettings();
  saveSettings();
  alert('Settings reset!');
};

document.getElementById('refreshStatsBtn').onclick=()=>{updateStats();};

document.getElementById('clearHistoryBtn').onclick=()=>{
  if(confirm('Clear all generation history?')){
    setStorage('history',[]);
    renderHistory();
    updateStats();
  }
};

document.getElementById('generateBtn').onclick=generateAndRender;
</script>
</body>
</html>