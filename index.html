<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>A Game a Day ‚Äî Ultra AI Edition</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --accent1:#0b74d1;
  --accent2:#a11ad8;
  --accent3:#ff5a7a;
}
body{
  margin:0;
  font-family:"SF Pro Display","Inter",sans-serif;
  background:linear-gradient(135deg,#0b74d1,#a11ad8,#ff5a7a);
  background-size:300% 300%;
  animation:bgShift 12s linear infinite;
  color:#fff;
  overflow-x:hidden;
}
@keyframes bgShift{
  0%{background-position:0% 50%;}
  50%{background-position:100% 50%;}
  100%{background-position:0% 50%;}
}
#appContainer{opacity:0;transition:opacity 0.6s;}
header{
  display:flex;align-items:center;justify-content:center;gap:12px;
  padding:22px 18px;
  backdrop-filter:blur(6px);
  background:rgba(0,0,0,0.2);
  position:sticky;top:0;z-index:10;
}
.logo{
  width:52px;height:52px;border-radius:12px;background:#fff;color:#0b74d1;
  display:flex;align-items:center;justify-content:center;font-weight:800;font-size:18px;
  cursor:pointer;
}
header h1{margin:0;font-size:20px;color:#051225;}
.tabs{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;padding:16px 20px;backdrop-filter:blur(6px);background:rgba(0,0,0,0.15);position:sticky;top:96px;z-index:9;}
.tab{background:rgba(255,255,255,0.1);color:#fff;border:none;padding:10px 18px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s;font-size:14px;position:relative;}
.tab:hover{background:rgba(255,255,255,0.18);transform:translateY(-2px);}
.tab.active{background:rgba(255,255,255,0.25);box-shadow:0 4px 12px rgba(0,0,0,0.2);}
.tab-badge{position:absolute;top:-6px;right:-6px;background:var(--accent3);color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;}
.tab-content{display:none;animation:fadeIn 0.3s ease;}
.tab-content.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
.container{max-width:1200px;margin:26px auto;padding:0 20px 80px;}
.controls{display:flex;gap:12px;flex-wrap:wrap;justify-content:center;margin-bottom:14px;}
input[type=text],input[type=number],select{min-width:220px;max-width:420px;padding:12px 14px;border-radius:10px;border:none;background:rgba(255,255,255,0.06);color:#fff;outline:none;}
input::placeholder{color: rgba(255,255,255,0.6);}
select{color:#fff;cursor:pointer;}
select option{background:#1a1a2e;color:#fff;}
.btn{background:rgba(255,255,255,0.12);color:#fff;border:none;padding:11px 14px;border-radius:10px;font-weight:700;cursor:pointer;transition:transform .15s ease, background .15s;}
.btn:hover{transform:translateY(-3px);background:rgba(255,255,255,0.18);}
.btn-small{padding:6px 10px;font-size:12px;}
.btn-fav{position:absolute;right:10px;top:10px;background:rgba(255,255,255,0.2);border:none;color:#fff;width:28px;height:28px;border-radius:50%;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;transition:all .2s;}
.btn-fav:hover{background:rgba(255,255,255,0.3);transform:scale(1.1);}
.btn-fav.favorited{background:var(--accent3);color:#fff;}
.calendar{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:14px;}
.card{border-radius:14px;padding:14px;min-height:130px;position:relative;color:#fff;box-shadow:0 8px 30px rgba(2,8,23,0.28);transition:transform .18s ease,box-shadow .18s ease;overflow:hidden;border:1px solid rgba(255,255,255,0.06);}
.card:hover{transform:translateY(-6px);box-shadow:0 18px 38px rgba(2,8,23,0.36);}
.num{font-weight:800;margin-bottom:8px;}
.short{font-size:14px;line-height:1.4;color:rgba(255,255,255,0.95);}
.tooltip{position:absolute;left:12px;top:10px;background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:8px;font-size:12px;opacity:0;transition:opacity .18s;}
.card:hover .tooltip{opacity:1;}
.search-box{width:100%;max-width:600px;margin:0 auto 20px;position:relative;}
.search-box input{width:100%;padding-right:40px;}
.search-icon{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:0.6;}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:20px 0;}
.stat-card{background:rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center;backdrop-filter:blur(10px);}
.stat-value{font-size:32px;font-weight:800;margin:8px 0;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.stat-label{font-size:14px;opacity:0.9;}
.settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0;}
.setting-item{background:rgba(255,255,255,0.08);border-radius:10px;padding:16px;}
.setting-item label{display:block;margin-bottom:8px;font-weight:600;font-size:14px;}
.quick-idea-box{background:rgba(255,255,255,0.1);border-radius:14px;padding:24px;margin:20px auto;max-width:700px;text-align:center;backdrop-filter:blur(10px);}
.quick-idea-box h3{margin:0 0 16px;font-size:20px;}
.idea-display{background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;margin:16px 0;text-align:left;}
.idea-display .idea-title{font-size:18px;font-weight:700;margin-bottom:12px;color:#fff;}
.idea-display .idea-desc{font-size:14px;line-height:1.6;opacity:0.95;}
.empty-state{text-align:center;padding:60px 20px;opacity:0.7;}
.empty-state-icon{font-size:48px;margin-bottom:16px;}
.modal{display:none;position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.7);align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity 0.5s ease;}
.modal.visible{display:flex;opacity:1;}
.panel{background:#fff;border-radius:12px;max-width:820px;width:92%;max-height:86%;overflow:auto;padding:22px;position:relative;color:#071226;transform:translateY(20px);transition:transform 0.4s ease;}
.modal.visible .panel{transform:translateY(0);}
.panel h2{margin:0 0 8px;font-size:18px;}
.panel p{margin:8px 0 0;color:#24303b;line-height:1.6;}
.close{position:absolute;right:12px;top:12px;border:none;background:transparent;font-size:20px;cursor:pointer;font-weight:700;}
.copy-btn{position:absolute;right:12px;bottom:12px;border:none;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
.share-btn{position:absolute;right:80px;bottom:12px;border:none;background:rgba(11,116,209,0.8);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer;}
.loadingOverlay{display:none;position:fixed;left:0;top:0;width:100%;height:100%;z-index:2000;align-items:center;justify-content:center;flex-direction:column;background:radial-gradient(circle at center,#001830,#000);transition:transform 0.5s ease,opacity 0.5s ease;}
.loadingOverlay.hidden{transform:translateY(-100%);opacity:0;}
.loadingCard{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.015));border-radius:14px;padding:18px;width:420px;max-width:92%;text-align:center;box-shadow:0 20px 70px rgba(2,8,23,0.5);}
.loadingCard h3{margin:0 0 8px;font-size:18px;color:#fff;}
.loadingInfo{font-size:13px;color:rgba(255,255,255,0.9);margin-bottom:12px;}
.progress{height:10px;background:rgba(255,255,255,0.08);border-radius:999px;overflow:hidden;}
.progress>i{display:block;height:100%;width:0%;background:linear-gradient(90deg,#0b74d1,#a11ad8,#ff5a7a);transition:width .9s linear;}
</style>
</head>
<body>
<div id="appContainer">
<header>
  <div class="logo" id="logoBtn">AGD</div>
  <h1>A Game a Day ‚Äî Ultra AI Edition</h1>
</header>

<div class="tabs">
  <button class="tab active" data-tab="generator">üéÆ Generator</button>
  <button class="tab" data-tab="quick">‚ö° Quick Idea</button>
  <button class="tab" data-tab="favorites">‚≠ê Favorites<span class="tab-badge" id="favBadge" style="display:none;">0</span></button>
  <button class="tab" data-tab="history">üìú History</button>
  <button class="tab" data-tab="stats">üìä Stats</button>
  <button class="tab" data-tab="settings">‚öôÔ∏è Settings</button>
</div>

<!-- Generator Tab -->
<div class="tab-content active" id="generator">
  <div class="container">
    <div class="controls">
      <input id="titleInput" type="text" placeholder="Game title (optional)">
      <input id="descInput" type="text" placeholder="Short description (optional)">
      <button class="btn" id="generateBtn">Generate Ideas</button>
    </div>
    <div class="search-box">
      <input id="searchInput" type="text" placeholder="üîç Search ideas...">
    </div>
    <div class="calendar" id="calendar"></div>
    <div style="display:flex;gap:12px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
      <button class="btn" id="downloadBtn">Download (.txt)</button>
      <button class="btn" id="downloadJsonBtn">Download (.json)</button>
      <button class="btn" id="downloadCsvBtn">Download (.csv)</button>
    </div>
  </div>
</div>

<!-- Quick Idea Tab -->
<div class="tab-content" id="quick">
  <div class="container">
    <div class="quick-idea-box">
      <h3>Get a Random Game Idea Instantly</h3>
      <button class="btn" id="quickGenerateBtn" style="margin-bottom:20px;">Generate Random Idea</button>
      <div id="quickIdeaDisplay" style="display:none;">
        <div class="idea-display">
          <div class="idea-title" id="quickTitle"></div>
          <div class="idea-desc" id="quickDesc"></div>
        </div>
        <div style="display:flex;gap:10px;justify-content:center;margin-top:16px;">
          <button class="btn btn-small" id="quickFavoriteBtn">‚≠ê Favorite</button>
          <button class="btn btn-small" id="quickCopyBtn">üìã Copy</button>
          <button class="btn btn-small" id="quickShareBtn">üîó Share</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Favorites Tab -->
<div class="tab-content" id="favorites">
  <div class="container">
    <div class="search-box">
      <input id="favSearchInput" type="text" placeholder="üîç Search favorites...">
    </div>
    <div class="calendar" id="favoritesContainer"></div>
    <div id="favEmptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">‚≠ê</div>
      <p>No favorites yet. Start favoriting ideas you love!</p>
    </div>
  </div>
</div>

<!-- History Tab -->
<div class="tab-content" id="history">
  <div class="container">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
      <h3 style="margin:0;">Generation History</h3>
      <button class="btn btn-small" id="clearHistoryBtn">Clear History</button>
    </div>
    <div id="historyContainer"></div>
    <div id="historyEmptyState" class="empty-state" style="display:none;">
      <div class="empty-state-icon">üìú</div>
      <p>No generation history yet. Start generating ideas!</p>
    </div>
  </div>
</div>

<!-- Stats Tab -->
<div class="tab-content" id="stats">
  <div class="container">
    <h3 style="text-align:center;margin-bottom:24px;">Your Statistics</h3>
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">Total Ideas Generated</div>
        <div class="stat-value" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Favorite Ideas</div>
        <div class="stat-value" id="statFavorites">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Generations</div>
        <div class="stat-value" id="statGenerations">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Most Used Genre</div>
        <div class="stat-value" id="statGenre" style="font-size:20px;">-</div>
      </div>
    </div>
    <div style="margin-top:32px;text-align:center;">
      <button class="btn" id="refreshStatsBtn">Refresh Stats</button>
    </div>
  </div>
</div>

<!-- Settings Tab -->
<div class="tab-content" id="settings">
  <div class="container">
    <h3 style="text-align:center;margin-bottom:24px;">Settings</h3>
    <div class="settings-grid">
      <div class="setting-item">
        <label>Number of Days to Generate</label>
        <input type="number" id="settingDays" min="1" max="365" value="30">
      </div>
      <div class="setting-item">
        <label>Default Export Format</label>
        <select id="settingExport">
          <option value="txt">Text (.txt)</option>
          <option value="json">JSON (.json)</option>
          <option value="csv">CSV (.csv)</option>
        </select>
      </div>
      <div class="setting-item">
        <label>Auto-save to History</label>
        <select id="settingAutoSave">
          <option value="true">Yes</option>
          <option value="false">No</option>
        </select>
      </div>
    </div>
    <div style="margin-top:24px;text-align:center;">
      <button class="btn" id="saveSettingsBtn">Save Settings</button>
      <button class="btn" id="resetSettingsBtn" style="margin-left:12px;">Reset to Defaults</button>
    </div>
  </div>
</div>

<!-- Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <button class="close" id="closeModal">√ó</button>
    <div id="panelContent"></div>
    <button class="share-btn" id="shareBtn">Share</button>
    <button class="copy-btn" id="copyBtn">Copy</button>
  </div>
</div>

<!-- Loading -->
<div class="loadingOverlay" id="loading">
  <div class="loadingCard">
    <h3>Generating ideas</h3>
    <div class="loadingInfo" id="loadingSub">Preparing...</div>
    <div class="progress"><i id="progressBar"></i></div>
    <div class="loadingInfo" id="loadingPct">0%</div>
  </div>
</div>
</div>

<script>
function sleep(ms){return new Promise(res=>setTimeout(res,ms));}
function rand(arr){return arr[Math.floor(Math.random()*arr.length)];}

const genres=['RPG','Platformer','Horror','Roguelike','Shooter','Simulation','Strategy','Mystery','Rhythm','Adventure','Puzzle','Metroidvania','Action','Stealth','Card','Sandbox','City Builder','VR','AR','Narrative','Survival','Fantasy','Sci-Fi','Historical','Cyberpunk','Noir','Western','Post-Apocalyptic','Space','Comedy','Slice of Life'];
const gameSettings=['a floating sky city','a haunted carnival','a neon cyber-metro','a quiet mountain village','an underwater research base','a desert planet outpost','a post-war bunker','a futuristic Tokyo district','a cursed forest','a digital dream world','an abandoned theme park','a medieval academy','a crumbling megacity','a pirate skyship','a moon colony','a misty swamp town','a massive AI core','a gothic cathedral','a snowy tundra settlement','a sunken city of glass'];
const mechanics=['time-loop progression','deck-building choices','squad management','gravity-based puzzles','musical combat','resource crafting','turn-based tactics','stealth infiltration','dialogue branching','combat rhythm sync','shape-shifting abilities','ecosystem simulation','roguelike dungeons','card fusion system','emotion-based AI companions','multi-timeline switching','reputation diplomacy','building physics simulation','team synergy combos','shadow possession'];
const storyHooks=['you awaken with your memories rewritten','your twin controls your shadow self','a forgotten song reshapes reality','a virus spreads through dreams','you lead refugees across broken dimensions','your choices rewrite past events','a rival mirrors your every move','you must uncover who programmed your fate','a city runs on bottled emotions','you hunt your future self','time fractures each dawn','your world ends every midnight','an AI writes new laws daily','the moon vanishes every night','you rebuild a civilization from echoes','magic runs through sound frequencies'];

// Storage helpers
function getStorage(key,defaultVal=[]){const v=localStorage.getItem(key);return v?JSON.parse(v):defaultVal;}
function setStorage(key,val){localStorage.setItem(key,JSON.stringify(val));}

// State
const appContainer = document.getElementById('appContainer');
const calendarEl=document.getElementById('calendar');
const modal=document.getElementById('modal');
const panel=document.getElementById('panelContent');
const copyBtn=document.getElementById('copyBtn');
const shareBtn=document.getElementById('shareBtn');
const closeModalBtn=document.getElementById('closeModal');
const logoBtn=document.getElementById('logoBtn');
const loading=document.getElementById('loading');
const progressBar=document.getElementById('progressBar');
const loadingPct=document.getElementById('loadingPct');
let currentIdeas=[];
let currentModalIdea=null;
let currentModalDay=0;

// Settings
let settings={days:30,export:'txt',autoSave:true};
function loadSettings(){const s=getStorage('settings',settings);settings={...settings,...s};}
function saveSettings(){setStorage('settings',settings);}
function applySettings(){
  const daysEl=document.getElementById('settingDays');
  const exportEl=document.getElementById('settingExport');
  const autoSaveEl=document.getElementById('settingAutoSave');
  if(daysEl)daysEl.value=settings.days;
  if(exportEl)exportEl.value=settings.export;
  if(autoSaveEl)autoSaveEl.value=settings.autoSave.toString();
}

// Tab switching
function initTabs(){
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
      if(tab.dataset.tab==='favorites')renderFavorites();
      if(tab.dataset.tab==='history')renderHistory();
      if(tab.dataset.tab==='stats')updateStats();
    };
  });
}

// Initialize on load
window.addEventListener('load',()=>{
  loadSettings();
  applySettings();
  initTabs();
  appContainer.style.opacity='1';
  updateFavBadge();
  renderFavorites();
  renderHistory();
  updateStats();
});

// Modal
function fadeOutModal(){
  modal.style.opacity='0';
  setTimeout(()=>{modal.style.display='none';modal.classList.remove('visible');modal.style.opacity='';},500);
}
closeModalBtn.onclick=()=>fadeOutModal();
modal.onclick=e=>{if(e.target===modal)fadeOutModal();};

copyBtn.onclick=()=>{
  if(!currentModalIdea)return;
  const text=`${currentModalIdea.short}\n\n${currentModalIdea.explanation}`;
  navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
};

shareBtn.onclick=()=>{
  if(!currentModalIdea)return;
  const text=`üéÆ Game Idea: ${currentModalIdea.short}\n\n${currentModalIdea.explanation}`;
  if(navigator.share){
    navigator.share({title:'Game Idea',text:text}).catch(()=>{});
  }else{
    navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
  }
};

// Logo resets app
logoBtn.onclick = () => {
  appContainer.style.opacity='0';
  setTimeout(()=>{
    calendarEl.innerHTML='';
    currentIdeas=[];
    document.getElementById('titleInput').value='';
    document.getElementById('descInput').value='';
    document.getElementById('searchInput').value='';
    fadeOutModal();
    appContainer.style.opacity='1';
  },600);
};

async function showLoading(seconds,text){
  loading.style.display='flex';
  document.getElementById('loadingSub').textContent=text;
  progressBar.style.width='0%';
  loadingPct.textContent='0%';
  for(let i=1;i<=seconds;i++){
    progressBar.style.width=Math.min(100,Math.round(i/seconds*100))+'%';
    loadingPct.textContent=Math.min(100,Math.round(i/seconds*100))+'%';
    await sleep(200);
  }
}

function buildIdea(title, desc){
  const g=[rand(genres),rand(genres),rand(genres)].filter((v,i,a)=>a.indexOf(v)===i).slice(0,rand([1,2,3]));
  const s=rand(gameSettings); const m=rand(mechanics); const h=rand(storyHooks);
  const adjectives=["Crimson","Neon","Shadow","Silent","Echo","Phantom","Eternal","Crystal","Solar","Iron","Velvet","Dream","Infinite","Midnight","Azure","Golden","Arcane","Forgotten","Digital","Frozen","Titan","Spectral","Burning","Emerald"];
  const nouns=["Odyssey","Protocol","Frontier","Legacy","Descent","Haven","Circuit","Genesis","Chronicle","Abyss","Empire","Horizon","Velocity","Tide","Sanctum","Hollow","Labyrinth","Catalyst","Pulse","Voyage","Realm","Shift","Beacon","Domain"];
  function smartTitleFrom(descText){
    const d=(descText||"").toLowerCase();
    if(d.includes("fun")||d.includes("happy"))return rand(["Joy Horizon","Color Quest","Happy Fields"]);
    if(d.includes("dark")||d.includes("scary")||d.includes("fear"))return rand(["Shadow Genesis","Phantom Descent","Eclipse Veil"]);
    if(d.includes("space")||d.includes("future")||d.includes("tech"))return rand(["Neon Frontier","Echo Circuit","Digital Odyssey"]);
    if(d.includes("magic")||d.includes("fantasy")||d.includes("mystic"))return rand(["Arcane Horizon","Crystal Haven","Forgotten Realm"]);
    if(d.includes("war")||d.includes("fight")||d.includes("battle"))return rand(["Iron Protocol","Crimson Empire","Tactical Horizon"]);
    return rand(adjectives)+" "+rand(nouns);
  }
  const focus=title?.trim()?title.trim():(desc?.trim()?smartTitleFrom(desc):smartTitleFrom(""));
  const short=`${g.join(" / ")} ‚Äî Set in ${s}. Core mechanic: ${m}. Story hook: ${h}. Title: "${focus}".`;
  const explanation=`This concept mixes ${g.join(', ')} elements in ${s}. The core loop revolves around ${m}, and the main narrative tension is: ${h}. The name "${focus}" ties the style and mood together for a cohesive creative theme.`;
  return {short,explanation,primary:g[0],genres:g,setting:s,mechanic:m,hook:h,title:focus,id:Date.now()+Math.random()};
}

function createCard(idea,day,showFav=true){
  const card=document.createElement('div');
  card.className='card';
  card.dataset.ideaId=idea.id;
  const favs=getStorage('favorites',[]);
  const isFav=favs.some(f=>f.id===idea.id);
  card.style.background=`linear-gradient(180deg, #0b74d1, rgba(0,0,0,0.14))`;
  card.innerHTML=`<div class="num">${day?`Day ${day}`:'Idea'}</div><div class="short">${idea.short}</div><div class="tooltip">Click for details</div>${showFav?`<button class="btn-fav ${isFav?'favorited':''}" data-idea-id="${idea.id}">${isFav?'‚≠ê':'‚òÜ'}</button>`:''}`;
  card.onclick=(e)=>{if(!e.target.classList.contains('btn-fav'))openModal(idea,day);};
  if(showFav){
    const favBtn=card.querySelector('.btn-fav');
    favBtn.onclick=(e)=>{e.stopPropagation();toggleFavorite(idea);};
  }
  return card;
}

function openModal(idea,day){
  currentModalIdea=idea;
  currentModalDay=day;
  panel.innerHTML='';
  const h=document.createElement('h2');
  h.textContent=day?`Day ${day} ‚Äî ${idea.short}`:idea.short;
  const p=document.createElement('p');
  p.textContent=idea.explanation;
  panel.appendChild(h);
  panel.appendChild(p);
  modal.classList.add('visible');
  modal.style.display='flex';
}

function toggleFavorite(idea){
  let favs=getStorage('favorites',[]);
  const idx=favs.findIndex(f=>f.id===idea.id);
  if(idx>=0){
    favs.splice(idx,1);
    document.querySelectorAll(`[data-idea-id="${idea.id}"]`).forEach(btn=>{
      btn.classList.remove('favorited');
      btn.textContent='‚òÜ';
    });
  }else{
    favs.push(idea);
    document.querySelectorAll(`[data-idea-id="${idea.id}"]`).forEach(btn=>{
      btn.classList.add('favorited');
      btn.textContent='‚≠ê';
    });
  }
  setStorage('favorites',favs);
  updateFavBadge();
  if(document.getElementById('favorites').classList.contains('active'))renderFavorites();
}

function updateFavBadge(){
  const favs=getStorage('favorites',[]);
  const badge=document.getElementById('favBadge');
  if(favs.length>0){
    badge.textContent=favs.length;
    badge.style.display='flex';
  }else{
    badge.style.display='none';
  }
}

function renderFavorites(){
  const favs=getStorage('favorites',[]);
  const container=document.getElementById('favoritesContainer');
  const empty=document.getElementById('favEmptyState');
  container.innerHTML='';
  const searchTerm=document.getElementById('favSearchInput').value.toLowerCase();
  const filtered=favs.filter(f=>!searchTerm||f.short.toLowerCase().includes(searchTerm)||f.explanation.toLowerCase().includes(searchTerm));
  if(filtered.length===0){
    container.style.display='none';
    empty.style.display='block';
  }else{
    container.style.display='grid';
    empty.style.display='none';
    filtered.forEach((idea,i)=>{container.appendChild(createCard(idea,i+1,false));});
  }
}

function renderHistory(){
  const history=getStorage('history',[]);
  const container=document.getElementById('historyContainer');
  const empty=document.getElementById('historyEmptyState');
  container.innerHTML='';
  if(history.length===0){
    container.style.display='none';
    empty.style.display='block';
  }else{
    container.style.display='block';
    empty.style.display='none';
    history.reverse().forEach((entry,idx)=>{
      const div=document.createElement('div');
      div.style.background='rgba(255,255,255,0.08)';
      div.style.borderRadius='10px';
      div.style.padding='16px';
      div.style.marginBottom='12px';
      const date=new Date(entry.timestamp);
      div.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:start;flex-wrap:wrap;gap:12px;"><div><strong>${date.toLocaleString()}</strong><div style="font-size:13px;opacity:0.8;margin-top:4px;">${entry.count} ideas generated</div></div><button class="btn btn-small" onclick="loadHistoryEntry(${history.length-1-idx})">Load</button></div>`;
      container.appendChild(div);
    });
  }
}

window.loadHistoryEntry=(idx)=>{
  const history=getStorage('history',[]);
  const entry=history[history.length-1-idx];
  if(entry){
    currentIdeas=entry.ideas;
    calendarEl.innerHTML='';
    currentIdeas.forEach((idea,i)=>{
      calendarEl.appendChild(createCard(idea,i+1));
    });
    document.querySelector('[data-tab="generator"]').click();
  }
};

function updateStats(){
  const history=getStorage('history',[]);
  const favs=getStorage('favorites',[]);
  let totalIdeas=0;
  const genreCount={};
  history.forEach(h=>{
    totalIdeas+=h.ideas.length;
    h.ideas.forEach(i=>{
      if(i.genres) i.genres.forEach(g=>{genreCount[g]=(genreCount[g]||0)+1;});
    });
  });
  document.getElementById('statTotal').textContent=totalIdeas;
  document.getElementById('statFavorites').textContent=favs.length;
  document.getElementById('statGenerations').textContent=history.length;
  const topGenre=Object.keys(genreCount).reduce((a,b)=>genreCount[a]>genreCount[b]?a:b,'-');
  document.getElementById('statGenre').textContent=topGenre;
}

async function generateAndRender(){
  const title=document.getElementById('titleInput').value;
  const desc=document.getElementById('descInput').value;
  const words=(title+' '+desc).trim().split(/\s+/).filter(Boolean).length||1;
  await showLoading(Math.max(1,words),"Preparing your ideas...");
  loading.classList.add('hidden');
  await sleep(300);
  loading.style.display='none';
  loading.classList.remove('hidden');
  calendarEl.innerHTML='';
  currentIdeas=[];
  const numDays=parseInt(settings.days)||30;
  for(let i=0;i<numDays;i++){
    const idea=buildIdea(title,desc);
    currentIdeas.push(idea);
    calendarEl.appendChild(createCard(idea,i+1));
  }
  if(settings.autoSave){
    const history=getStorage('history',[]);
    history.push({timestamp:Date.now(),ideas:currentIdeas,count:currentIdeas.length,title,desc});
    if(history.length>50)history.shift();
    setStorage('history',history);
  }
  updateStats();
}

// Search
document.getElementById('searchInput').addEventListener('input',(e)=>{
  const term=e.target.value.toLowerCase();
  document.querySelectorAll('#calendar .card').forEach(card=>{
    const text=card.textContent.toLowerCase();
    card.style.display=!term||text.includes(term)?'block':'none';
  });
});

document.getElementById('favSearchInput').addEventListener('input',()=>{renderFavorites();});

// Quick Idea
document.getElementById('quickGenerateBtn').onclick=()=>{
  const idea=buildIdea('','');
  document.getElementById('quickTitle').textContent=idea.short;
  document.getElementById('quickDesc').textContent=idea.explanation;
  document.getElementById('quickIdeaDisplay').style.display='block';
  const favBtn=document.getElementById('quickFavoriteBtn');
  const favs=getStorage('favorites',[]);
  const isFav=favs.some(f=>f.id===idea.id);
  favBtn.textContent=isFav?'‚≠ê Unfavorite':'‚≠ê Favorite';
  favBtn.onclick=()=>{toggleFavorite(idea);favBtn.textContent=favs.some(f=>f.id===idea.id)?'‚≠ê Unfavorite':'‚≠ê Favorite';};
  document.getElementById('quickCopyBtn').onclick=()=>{
    navigator.clipboard.writeText(`${idea.short}\n\n${idea.explanation}`).then(()=>{alert('Copied!');});
  };
  document.getElementById('quickShareBtn').onclick=()=>{
    const text=`üéÆ Game Idea: ${idea.short}\n\n${idea.explanation}`;
    if(navigator.share){
      navigator.share({title:'Game Idea',text:text}).catch(()=>{});
    }else{
      navigator.clipboard.writeText(text).then(()=>{alert('Copied to clipboard!');});
    }
  };
};

// Export functions
document.getElementById('downloadBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  let txt='A Game a Day ‚Äî Ultra AI Edition\n\n';
  currentIdeas.forEach((it,i)=>{txt+=`Day ${i+1}:\n${it.short}\n${it.explanation}\n\n`;});
  const blob=new Blob([txt],{type:'text/plain'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

document.getElementById('downloadJsonBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  const json=JSON.stringify(currentIdeas,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

document.getElementById('downloadCsvBtn').onclick=()=>{
  if(!currentIdeas.length){alert('Generate ideas first');return;}
  let csv='Day,Short Description,Full Explanation\n';
  currentIdeas.forEach((it,i)=>{csv+=`${i+1},"${it.short.replace(/"/g,'""')}","${it.explanation.replace(/"/g,'""')}"\n`;});
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='a_game_a_day_ideas.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
};

// Settings
document.getElementById('saveSettingsBtn').onclick=()=>{
  settings.days=parseInt(document.getElementById('settingDays').value)||30;
  settings.export=document.getElementById('settingExport').value;
  settings.autoSave=document.getElementById('settingAutoSave').value==='true';
  saveSettings();
  alert('Settings saved!');
};

document.getElementById('resetSettingsBtn').onclick=()=>{
  settings={days:30,export:'txt',autoSave:true};
  applySettings();
  saveSettings();
  alert('Settings reset!');
};

document.getElementById('refreshStatsBtn').onclick=()=>{updateStats();};

document.getElementById('clearHistoryBtn').onclick=()=>{
  if(confirm('Clear all generation history?')){
    setStorage('history',[]);
    renderHistory();
    updateStats();
  }
};

document.getElementById('generateBtn').onclick=generateAndRender;
</script>
</body>
</html>